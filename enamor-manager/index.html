<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enamor Index Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .entry-card {
            transition: all 0.3s ease;
        }
        .entry-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }
        .drop-zone.dragover {
            border-color: #667eea;
            background: #ede9fe;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold">Enamor Index Manager</h1>
                    <p class="text-blue-100 mt-2">Manage and explore your Enamor collection</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold" id="totalCount">0</div>
                    <div class="text-sm text-blue-100">Total Entries</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <!-- Action Bar -->
        <div id="actionBar" class="glass-effect rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-row items-center gap-2 flex-wrap">
                <!-- Search + Filters -->
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search by title or summary..." 
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent flex-1 min-w-[200px] text-sm"
                    onkeyup="filterEntries()"
                >
                
                <select id="yearFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-28 text-sm" onchange="filterEntries()">
                    <option value="">All Years</option>
                </select>
                <select id="monthFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-32 text-sm" onchange="filterEntries()">
                    <option value="">All Months</option>
                </select>
                <select id="tagFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-32 text-sm" onchange="document.getElementById('tagFilterSidePanel').value = this.value; filterEntries();">
                    <option value="">All Tags</option>
                </select>
                
                <button onclick="showAll()" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-1 whitespace-nowrap text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Show All
                </button>

                <!-- Actions -->
                <label class="cursor-pointer">
                    <div class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-1 whitespace-nowrap text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Load JSON
                    </div>
                    <input type="file" id="loadJsonInput" accept=".json" class="hidden" onchange="handleFileLoad(event)">
                </label>
                <label class="cursor-pointer">
                    <div class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-1 whitespace-nowrap text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Load Header
                    </div>
                    <input type="file" id="loadHeaderInput" accept="image/*" class="hidden" onchange="handleHeaderLoad(event)">
                </label>
                <button onclick="backupJSON()" class="px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition flex items-center gap-1 whitespace-nowrap text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Export JSON
                </button>
                <button onclick="exportToPDF()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-1 whitespace-nowrap text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export PDF
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="statsSection" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">Latest Entry</p>
                <p class="text-xl font-bold text-blue-600" id="latestEntry">-</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">Current Month</p>
                <p class="text-xl font-bold text-purple-600" id="currentMonth">-</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">Filtered Count</p>
                <p class="text-xl font-bold text-green-600" id="filteredCount">0</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">Total Months</p>
                <p class="text-xl font-bold text-orange-600" id="totalMonths">0</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">Avg/Month</p>
                <p class="text-xl font-bold text-pink-600" id="avgPerMonth">0</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <p class="text-gray-500 text-xs mb-1 font-semibold">This Month</p>
                <p class="text-xl font-bold text-indigo-600" id="thisMonthCount">0</p>
            </div>
        </div>

        <!-- Main Content Area with Side Panels -->
        <div class="flex gap-4">
            <!-- Tags Side Panel (Left) -->
            <div id="tagsSidePanel" class="hidden w-56 bg-white rounded-lg shadow-lg p-4 sticky top-6 self-start max-h-[calc(100vh-8rem)] overflow-y-auto flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    Tags
                </h3>
                
                <!-- Tag Filter Dropdown -->
                <div class="mb-4">
                    <select id="tagFilterSidePanel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" onchange="document.getElementById('tagFilter').value = this.value; filterEntries();">
                        <option value="">All Tags</option>
                    </select>
                </div>
                
                <div id="tagsListContainer" class="space-y-2">
                    <!-- Tags will be populated here -->
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 min-w-0 overflow-x-auto">
                <!-- Entries Grid -->
                <div id="entriesContainer" class="grid grid-cols-1 gap-6">
            <div class="col-span-full bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-12 text-center">
                <svg class="w-20 h-20 text-blue-600 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Click "Load JSON" button above</h2>
                <p class="text-gray-600 text-lg">Select your enamor-index.json file to view all entries</p>
            </div>
        </div>
            </div>

            <!-- Topics/Subtopics Side Panel (Right) -->
            <div id="topicsPanel" class="hidden w-64 bg-white rounded-lg shadow-lg sticky top-6 self-start max-h-[calc(100vh-8rem)] overflow-y-auto flex-shrink-0">
                <div class="p-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Topics & Subtopics
                    </h3>
                    
                    <div id="topicsListContainer" class="space-y-2">
                        <!-- Topics will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="gradient-bg text-white p-6 rounded-t-lg">
                <h2 class="text-2xl font-bold">Edit Entry</h2>
            </div>
            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="edit_index">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Serial No</label>
                        <input type="text" id="edit_sr_no" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Edition</label>
                        <input type="text" id="edit_edition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                        <input type="text" id="edit_month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="text" id="edit_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="edit_title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
                    <input type="text" id="edit_link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Summary</label>
                    <textarea id="edit_summary" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tags (comma-separated)</label>
                    <input type="text" id="edit_tag" placeholder="e.g., reflection, travel, wisdom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Enter tags separated by commas</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Topic</label>
                        <input type="text" id="edit_topic" placeholder="e.g., Philosophy, Technology" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtopic</label>
                        <input type="text" id="edit_subtopic" placeholder="e.g., Ethics, AI" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex gap-3 justify-end pt-4">
                    <button type="button" onclick="closeEditModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="gradient-bg text-white p-6 rounded-t-lg flex justify-between items-center">
                <h2 class="text-2xl font-bold" id="summaryModalTitle">Entry Summary</h2>
                <button onclick="closeSummaryModal()" class="text-white hover:text-gray-200 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Edition:</span> <span id="summaryEdition"></span> |
                        <span class="font-semibold">Date:</span> <span id="summaryDate"></span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Tags:</span> <span id="summaryTags"></span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2" id="summaryTopicContainer" style="display: none;">
                        <span class="font-semibold">Topic:</span> <span id="summaryTopic"></span>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Summary</h3>
                    <div id="summaryContent" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                </div>
                <div class="mt-6 flex gap-3 justify-end">
                    <a id="summaryViewLink" href="#" target="_blank" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        View Full Article
                    </a>
                    <button onclick="closeSummaryModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allEntries = [];
        let filteredEntries = [];
        let headerImageBase64 = null;
        let headerBannerColor = { r: 30, g: 64, b: 175 }; // Default blue
        let hasUnsavedChanges = false;

        function formatSrNo(n) {
            const width = n < 100 ? 2 : 3;
            return String(n).padStart(width, '0');
        }

        function getMaxSrNo(entries) {
            let max = 0;
            for (const e of entries || []) {
                const n = parseInt(e?.sr_no, 10);
                if (Number.isFinite(n) && n > max) {
                    max = n;
                }
            }
            return max;
        }

        function getNextSrNo() {
            const nums = allEntries
                .map(e => parseInt(e.sr_no, 10))
                .filter(n => Number.isFinite(n));
            const next = (nums.length ? Math.max(...nums) : 0) + 1;
            return formatSrNo(next);
        }

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterEntries);
            document.getElementById('yearFilter').addEventListener('change', filterEntries);
            document.getElementById('monthFilter').addEventListener('change', filterEntries);
            document.getElementById('tagFilter').addEventListener('change', filterEntries);
            document.getElementById('editForm').addEventListener('submit', saveEntry);
        }
        
        

        function downloadCurrentJSON(filename) {
            const dataStr = JSON.stringify(allEntries, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function backupJSON() {
            if (allEntries.length === 0) {
                console.warn('Please load a JSON file first using the "Load JSON" button.');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadCurrentJSON(`enamor-index-backup-${timestamp}.json`);

            console.log(`Exported JSON: enamor-index-backup-${timestamp}.json`);
        }
        
        function handleFileLoad(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('Loading file:', file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        console.log('Parsed JSON:', jsonData);
                        console.log('Has entries field?', 'entries' in jsonData);
                        console.log('Is entries an array?', Array.isArray(jsonData.entries));
                        console.log('Is jsonData an array?', Array.isArray(jsonData));
                        
                        // Support new format with metadata and entries
                        let data;
                        if (jsonData.entries && Array.isArray(jsonData.entries)) {
                            console.log('Using new format with entries field');
                            data = jsonData.entries;
                        } else if (Array.isArray(jsonData)) {
                            console.log('Using old format (array)');
                            data = jsonData;
                        } else {
                            console.log('JSON structure:', Object.keys(jsonData));
                            throw new Error('JSON must be an array of entries or have an "entries" field');
                        }
                        
                        console.log('Data loaded:', data.length, 'entries');
                        
                        // Validate entries have required fields
                        if (data.length > 0) {
                            const firstEntry = data[0];
                            const requiredFields = ['sr_no', 'edition', 'month', 'date', 'title', 'link', 'summary'];
                            const hasAllFields = requiredFields.every(field => field in firstEntry);
                            
                            if (!hasAllFields) {
                                console.warn('Some entries may be missing fields:', firstEntry);
                            }
                        }
                        
                        allEntries = data;
                        
                        // Remove duplicates: keep entries with titles, remove empty duplicates
                        const seenSrNos = new Map();
                        allEntries = allEntries.filter(entry => {
                            const existing = seenSrNos.get(entry.sr_no);
                            if (!existing) {
                                seenSrNos.set(entry.sr_no, entry);
                                return true;
                            }
                            // If current has title and existing doesn't, replace
                            if (entry.title && !existing.title) {
                                seenSrNos.set(entry.sr_no, entry);
                                return true;
                            }
                            // If existing has title, keep existing (skip current)
                            if (existing.title) {
                                return false;
                            }
                            // Both empty, keep first one
                            return false;
                        });
                        
                        filteredEntries = [...allEntries];
                        console.log('Initializing app with', allEntries.length, 'entries');
                        initializeApp();
                    } catch (error) {
                        console.error('JSON parsing error:', error);
                        alert(`Error loading JSON file: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    console.error('Error reading file. Please try again.');
                    alert('Error reading file. Please try again.');
                };
                reader.readAsText(file);
            }
        }

        function cleanSummary(summary) {
            if (!summary) return '';
            
            // Remove YAML front matter (--- ... ---)
            let cleaned = summary.replace(/^---\s*\n[\s\S]*?\n---\s*\n/gm, '');
            
            // Remove specific YAML front matter keys at the beginning
            cleaned = cleaned.replace(/^layout\s*:\s*[^\n]*\s*/i, '');
            cleaned = cleaned.replace(/^title\s*:\s*[^\n]*\s*/i, '');
            cleaned = cleaned.replace(/^date\s*:\s*[^\n]*\s*/i, '');
            cleaned = cleaned.replace(/^tag\s*:\s*[^\n]*\s*/i, '');
            cleaned = cleaned.replace(/^topic\s*:\s*[^\n]*\s*/i, '');
            cleaned = cleaned.replace(/^subtopic\s*:\s*[^\n]*\s*/i, '');
            
            // Remove excess whitespace
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            return cleaned;
        }

        function initializeApp() {
            populateMonthFilter();
            populateTagFilter();
            updateStats();
            renderEntries();
        }

        function populateTagsSidePanel() {
            console.log('Populating tags side panel...');
            // Extract all unique tags and count articles for each
            const tagCounts = {};
            
            allEntries.forEach(entry => {
                if (entry.tag && Array.isArray(entry.tag)) {
                    entry.tag.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            
            console.log('Tag counts:', tagCounts);
            
            // Sort tags by count (descending) then alphabetically
            const sortedTags = Object.entries(tagCounts).sort((a, b) => {
                if (b[1] !== a[1]) return b[1] - a[1];
                return a[0].localeCompare(b[0]);
            });
            
            const container = document.getElementById('tagsListContainer');
            const sidePanel = document.getElementById('tagsSidePanel');
            
            if (sortedTags.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No tags found</p>';
                sidePanel.classList.add('hidden');
                return;
            }
            
            // Show side panel
            sidePanel.classList.remove('hidden');
            
            // Populate tags list
            container.innerHTML = sortedTags.map(([tag, count]) => {
                const color = getTagColor(tag);
                return `
                    <div onclick="filterByTag('${tag}')" 
                         class="flex items-center justify-between p-3 rounded-lg ${color.bg} ${color.text} cursor-pointer hover:opacity-80 transition group">
                        <span class="font-medium text-sm">${tag}</span>
                        <span class="bg-white bg-opacity-50 px-2 py-1 rounded text-xs font-bold">${count}</span>
                    </div>
                `;
            }).join('');
            console.log('Tags side panel populated with', sortedTags.length, 'tags');
        }

        function populateTagFilter() {
            // Extract all unique tags from data
            const tags = new Set();
            
            allEntries.forEach(e => {
                if (e.tag && Array.isArray(e.tag)) {
                    e.tag.forEach(t => tags.add(t));
                }
            });
            
            // Populate both tag filter dropdowns (main and side panel)
            const tagSelect = document.getElementById('tagFilter');
            const tagSelectSidePanel = document.getElementById('tagFilterSidePanel');
            
            const optionsHTML = '<option value="">All Tags</option>' + 
                [...tags].sort().map(tag => `<option value="${tag}">${tag}</option>`).join('');
            
            tagSelect.innerHTML = optionsHTML;
            tagSelectSidePanel.innerHTML = optionsHTML;
            
            // Also populate the side panel
            populateTagsSidePanel();
            
            // Show tags side panel
            document.getElementById('tagsSidePanel').classList.remove('hidden');
            
            // Show and build topics panel
            document.getElementById('topicsPanel').classList.remove('hidden');
            buildTopicsPanel();
        }
        
        function populateMonthFilter() {
            // Extract years from data
            const years = new Set();
            
            allEntries.forEach(e => {
                if (e.month) {
                    // Extract year from "Month Year" format
                    const parts = e.month.split(' ');
                    if (parts.length === 2) {
                        years.add(parts[1]); // Year
                    }
                }
            });
            
            // Populate year filter
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            [...years].sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Populate month filter with all 12 months
            const monthSelect = document.getElementById('monthFilter');
            monthSelect.innerHTML = '<option value="">All Months</option>';
            const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthOrder.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
        }

        function filterEntries() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            const selectedTag = document.getElementById('tagFilter').value;
            
            // Map full month names to abbreviations
            const monthAbbr = {
                'January': 'Jan', 'February': 'Feb', 'March': 'Mar', 'April': 'Apr',
                'May': 'May', 'June': 'Jun', 'July': 'Jul', 'August': 'Aug',
                'September': 'Sep', 'October': 'Oct', 'November': 'Nov', 'December': 'Dec'
            };
            
            filteredEntries = allEntries.filter(entry => {
                const matchesSearch = !searchTerm || 
                    entry.title.toLowerCase().includes(searchTerm) ||
                    entry.summary.toLowerCase().includes(searchTerm);
                
                let matchesYear = !selectedYear;
                let matchesMonth = !selectedMonth;
                let matchesTag = !selectedTag;
                
                if (entry.month) {
                    if (selectedYear) {
                        matchesYear = entry.month.includes(selectedYear);
                    }
                    if (selectedMonth) {
                        const abbr = monthAbbr[selectedMonth];
                        matchesMonth = entry.month.startsWith(abbr);
                    }
                }
                
                if (selectedTag && entry.tag && Array.isArray(entry.tag)) {
                    matchesTag = entry.tag.includes(selectedTag);
                }
                
                return matchesSearch && matchesYear && matchesMonth && matchesTag;
            });
            
            updateStats();
            renderEntries();
        }

        function showAll() {
            // Clear all filters
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('tagFilter').value = '';
            document.getElementById('tagFilterSidePanel').value = '';
            
            // Trigger filter to show all entries
            filterEntries();
        }

        function updateStats() {
            const maxSrNo = getMaxSrNo(allEntries);
            document.getElementById('totalCount').textContent = allEntries.length;
            document.getElementById('filteredCount').textContent = filteredEntries.length;
            
            if (allEntries.length > 0) {
                // Latest entry
                const latest = allEntries.find(e => parseInt(e?.sr_no, 10) === maxSrNo) || allEntries[allEntries.length - 1];
                document.getElementById('latestEntry').textContent = `#${maxSrNo}`;
                document.getElementById('currentMonth').textContent = latest?.month || '-';
                
                // Month statistics
                const monthCounts = {};
                allEntries.forEach(entry => {
                    if (entry.month) {
                        monthCounts[entry.month] = (monthCounts[entry.month] || 0) + 1;
                    }
                });
                
                const totalMonths = Object.keys(monthCounts).length;
                const avgPerMonth = totalMonths > 0 ? (allEntries.length / totalMonths).toFixed(1) : 0;
                
                document.getElementById('totalMonths').textContent = totalMonths;
                document.getElementById('avgPerMonth').textContent = avgPerMonth;
                
                // This month's count (based on latest entry month)
                const thisMonthCount = latest?.month ? (monthCounts[latest.month] || 0) : 0;
                document.getElementById('thisMonthCount').textContent = thisMonthCount;
            } else {
                document.getElementById('latestEntry').textContent = '-';
                document.getElementById('currentMonth').textContent = '-';
                document.getElementById('totalMonths').textContent = 0;
                document.getElementById('avgPerMonth').textContent = 0;
                document.getElementById('thisMonthCount').textContent = 0;
            }
        }

        function buildTopicsPanel() {
            const topicsMap = {};
            
            // Build hierarchical structure: topic -> subtopics -> entries
            allEntries.forEach((entry, index) => {
                const topic = entry.topic || '';
                const subtopic = entry.subtopic || '';
                
                if (topic) {
                    if (!topicsMap[topic]) {
                        topicsMap[topic] = { subtopics: {}, entries: [] };
                    }
                    
                    if (subtopic) {
                        if (!topicsMap[topic].subtopics[subtopic]) {
                            topicsMap[topic].subtopics[subtopic] = [];
                        }
                        topicsMap[topic].subtopics[subtopic].push({ entry, index });
                    } else {
                        topicsMap[topic].entries.push({ entry, index });
                    }
                }
            });
            
            // Sort topics alphabetically
            const sortedTopics = Object.keys(topicsMap).sort();
            
            if (sortedTopics.length === 0) {
                document.getElementById('topicsListContainer').innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-xs text-gray-600 mb-2">
                            <span class="font-semibold">No topics defined yet.</span>
                        </p>
                        <p class="text-xs text-gray-500 mb-3">
                            Topics help organize your entries by theme. Click "Edit" on any entry to add topics and subtopics.
                        </p>
                        <div class="bg-white rounded p-2 text-xs text-gray-600">
                            <p class="font-semibold mb-1">Example structure:</p>
                            <div class="ml-2">
                                <div>üìÅ <span class="font-semibold">Philosophy</span></div>
                                <div class="ml-4">‚Üí Ethics</div>
                                <div class="ml-4">‚Üí Metaphysics</div>
                                <div class="mt-2">üìÅ <span class="font-semibold">Travel</span></div>
                                <div class="ml-4">‚Üí Europe</div>
                                <div class="ml-4">‚Üí Asia</div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Build HTML for topics panel
            let html = '';
            sortedTopics.forEach(topic => {
                const topicData = topicsMap[topic];
                const totalCount = topicData.entries.length + 
                    Object.values(topicData.subtopics).reduce((sum, arr) => sum + arr.length, 0);
                
                const subtopics = Object.keys(topicData.subtopics).sort();
                
                html += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden mb-2">
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 px-3 py-2 cursor-pointer hover:bg-purple-100 transition"
                             onclick="toggleTopic('topic-${topic.replace(/\s+/g, '-')}')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-800">${topic}</span>
                                <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">${totalCount}</span>
                            </div>
                        </div>
                        <div id="topic-${topic.replace(/\s+/g, '-')}" class="hidden bg-white">
                `;
                
                // Add entries directly under topic (without subtopic)
                if (topicData.entries.length > 0) {
                    topicData.entries.forEach(({ entry, index }) => {
                        html += `
                            <div class="px-4 py-2 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition"
                                 onclick="showEntrySummary(${index})">
                                <div class="text-xs font-medium text-gray-700">${entry.title}</div>
                                <div class="text-xs text-gray-500">#${entry.sr_no} - ${entry.date}</div>
                            </div>
                        `;
                    });
                }
                
                // Add subtopics
                subtopics.forEach(subtopic => {
                    const subtopicEntries = topicData.subtopics[subtopic];
                    html += `
                        <div class="border-t border-gray-200">
                            <div class="bg-blue-50 px-4 py-2 cursor-pointer hover:bg-blue-100 transition"
                                 onclick="toggleSubtopic('subtopic-${topic.replace(/\s+/g, '-')}-${subtopic.replace(/\s+/g, '-')}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-semibold text-gray-700 ml-2">‚Üí ${subtopic}</span>
                                    <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full">${subtopicEntries.length}</span>
                                </div>
                            </div>
                            <div id="subtopic-${topic.replace(/\s+/g, '-')}-${subtopic.replace(/\s+/g, '-')}" class="hidden">
                    `;
                    
                    subtopicEntries.forEach(({ entry, index }) => {
                        html += `
                            <div class="px-6 py-2 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition"
                                 onclick="showEntrySummary(${index})">
                                <div class="text-xs font-medium text-gray-700">${entry.title}</div>
                                <div class="text-xs text-gray-500">#${entry.sr_no} - ${entry.date}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('topicsListContainer').innerHTML = html;
        }
        
        function toggleTopic(topicId) {
            const element = document.getElementById(topicId);
            element.classList.toggle('hidden');
        }
        
        function toggleSubtopic(subtopicId) {
            const element = document.getElementById(subtopicId);
            element.classList.toggle('hidden');
        }
        
        function showEntrySummary(index) {
            const entry = allEntries[index];
            const rowId = `entry-row-${entry.sr_no}`;
            const targetRow = document.getElementById(rowId);
            
            if (targetRow) {
                // Remove previous highlights
                document.querySelectorAll('tr[data-entry-index]').forEach(row => {
                    row.classList.remove('bg-yellow-100', 'ring-2', 'ring-yellow-400');
                });
                
                // Highlight the target row
                targetRow.classList.add('bg-yellow-100', 'ring-2', 'ring-yellow-400');
                
                // Scroll to the entry in the main table
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    targetRow.classList.remove('bg-yellow-100', 'ring-2', 'ring-yellow-400');
                }, 3000);
            }
        }
        
        function jumpToTopics() {
            const topicsPanel = document.getElementById('topicsPanel');
            if (topicsPanel && !topicsPanel.classList.contains('hidden')) {
                topicsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function getTagColor(tag) {
            // Predefined color palette for tags
            const colors = [
                { bg: 'bg-blue-100', text: 'text-blue-800' },
                { bg: 'bg-green-100', text: 'text-green-800' },
                { bg: 'bg-purple-100', text: 'text-purple-800' },
                { bg: 'bg-pink-100', text: 'text-pink-800' },
                { bg: 'bg-yellow-100', text: 'text-yellow-800' },
                { bg: 'bg-indigo-100', text: 'text-indigo-800' },
                { bg: 'bg-red-100', text: 'text-red-800' },
                { bg: 'bg-teal-100', text: 'text-teal-800' },
                { bg: 'bg-orange-100', text: 'text-orange-800' },
                { bg: 'bg-cyan-100', text: 'text-cyan-800' },
                { bg: 'bg-lime-100', text: 'text-lime-800' },
                { bg: 'bg-emerald-100', text: 'text-emerald-800' },
                { bg: 'bg-violet-100', text: 'text-violet-800' },
                { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800' },
                { bg: 'bg-rose-100', text: 'text-rose-800' },
                { bg: 'bg-sky-100', text: 'text-sky-800' },
                { bg: 'bg-amber-100', text: 'text-amber-800' }
            ];
            
            // Simple hash function for consistent color assignment
            let hash = 0;
            for (let i = 0; i < tag.length; i++) {
                hash = ((hash << 5) - hash) + tag.charCodeAt(i);
                hash = hash & hash; // Convert to 32bit integer
            }
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        function filterByTag(tagName) {
            // Set the tag filter dropdown to the clicked tag
            document.getElementById('tagFilter').value = tagName;
            document.getElementById('tagFilterSidePanel').value = tagName;
            // Trigger the filter
            filterEntries();
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No entries found</div>';
                return;
            }
            
            // Group entries by month
            const entriesByMonth = {};
            filteredEntries.forEach(entry => {
                const month = entry.month || 'Unknown';
                if (!entriesByMonth[month]) {
                    entriesByMonth[month] = [];
                }
                entriesByMonth[month].push(entry);
            });
            
            // Sort entries by date within each month
            Object.keys(entriesByMonth).forEach(month => {
                entriesByMonth[month].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
            });
            
            // Sort months chronologically
            const parseMonthYear = (monthYear) => {
                const [month, year] = monthYear.split(' ');
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'June': 5, 'Jul': 6, 'July': 6, 'Aug': 7, 'Sep': 8, 'Sept': 8,
                    'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                return new Date(parseInt(year), monthMap[month] || 0);
            };
            
            const sortedMonths = Object.keys(entriesByMonth).sort((a, b) => {
                return parseMonthYear(a) - parseMonthYear(b);
            });
            
            // Build HTML with grouped entries
            let tableHTML = '';
            sortedMonths.forEach((month, monthIndex) => {
                const monthEntries = entriesByMonth[month];
                
                // Month header row
                tableHTML += `
                    <tr class="bg-blue-50">
                        <td colspan="7" class="px-4 py-2 font-semibold text-xs">
                            <span class="text-gray-700">Month ${monthIndex + 1} -</span>
                            <span class="text-gray-700"> ${month}</span>
                            <span class="text-xs font-normal text-gray-600"> (${monthEntries.length} entries)</span>
                        </td>
                    </tr>
                `;
                
                // Entries for this month
                monthEntries.forEach((entry, index) => {
                    const tagsHTML = entry.tag && entry.tag.length > 0 
                        ? entry.tag.map(tag => {
                            const color = getTagColor(tag);
                            return `<span onclick="filterByTag('${tag}')" class="inline-block ${color.bg} ${color.text} text-xs px-2 py-1 rounded mr-1 mb-1 cursor-pointer hover:opacity-80 transition">${tag}</span>`;
                        }).join('')
                        : '<span class="text-gray-400">-</span>';
                    
                    tableHTML += `
                        <tr id="entry-row-${entry.sr_no}" class="border-b border-gray-200 hover:bg-gray-50 transition" data-entry-index="${allEntries.indexOf(entry)}">
                            <td class="px-4 py-3 text-xs font-medium text-gray-900">${entry.sr_no}</td>
                            <td class="px-4 py-3 text-xs text-gray-700">${entry.edition}</td>
                            <td class="px-4 py-3 text-xs text-gray-700">${entry.month}</td>
                            <td class="px-4 py-3 text-xs text-gray-700">${entry.date}</td>
                            <td class="px-4 py-3 text-xs font-semibold text-gray-900 max-w-[200px]">
                                <a href="${entry.link}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline truncate block">
                                    ${entry.title}
                                </a>
                            </td>
                            <td class="px-2 py-3 text-xs">
                                <div class="flex gap-1 justify-center">
                                    <button onclick="openEditModal(${allEntries.indexOf(entry)})" 
                                        class="p-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition" title="Edit">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="openSummaryModal(${allEntries.indexOf(entry)})" 
                                        class="p-1.5 bg-gray-600 text-white rounded hover:bg-gray-700 transition" title="View Summary">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-xs">
                                <div class="flex flex-wrap max-w-[100px]">${tagsHTML}</div>
                            </td>
                        </tr>
                    `;
                });
            });
            
            container.innerHTML = `
                <div class="col-span-full bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-16">Sr No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-20">Edition</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-24">Month</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-24">Date</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-48">Title</th>
                                    <th class="px-2 py-3 text-center text-sm font-semibold w-16">Actions</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold w-24">Tags</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function openEditModal(index) {
            const entry = allEntries[index];
            
            document.getElementById('edit_index').value = index;
            document.getElementById('edit_sr_no').value = entry.sr_no;
            document.getElementById('edit_edition').value = entry.edition;
            document.getElementById('edit_month').value = entry.month;
            document.getElementById('edit_date').value = entry.date;
            document.getElementById('edit_title').value = entry.title;
            document.getElementById('edit_link').value = entry.link;
            document.getElementById('edit_summary').value = entry.summary;
            document.getElementById('edit_tag').value = (entry.tag && Array.isArray(entry.tag)) ? entry.tag.join(', ') : '';
            document.getElementById('edit_topic').value = entry.topic || '';
            document.getElementById('edit_subtopic').value = entry.subtopic || '';
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function openSummaryModal(index) {
            const entry = allEntries[index];
            
            document.getElementById('summaryModalTitle').textContent = entry.title;
            document.getElementById('summaryEdition').textContent = entry.edition;
            document.getElementById('summaryDate').textContent = entry.date;
            
            // Tags
            const tagsHTML = entry.tag && entry.tag.length > 0 
                ? entry.tag.map(tag => {
                    const color = getTagColor(tag);
                    return `<span class="${color.bg} ${color.text} text-xs px-2 py-1 rounded mr-1">${tag}</span>`;
                  }).join('')
                : '<span class="text-gray-400">None</span>';
            document.getElementById('summaryTags').innerHTML = tagsHTML;
            
            // Topic/Subtopic
            if (entry.topic) {
                document.getElementById('summaryTopicContainer').style.display = 'block';
                const topicText = entry.subtopic 
                    ? `${entry.topic} ‚Üí ${entry.subtopic}`
                    : entry.topic;
                document.getElementById('summaryTopic').textContent = topicText;
            } else {
                document.getElementById('summaryTopicContainer').style.display = 'none';
            }
            
            // Summary
            document.getElementById('summaryContent').textContent = cleanSummary(entry.summary) || 'No summary available.';
            
            // View link
            document.getElementById('summaryViewLink').href = entry.link;
            
            document.getElementById('summaryModal').classList.add('active');
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        function applyEditFormToEntry() {
            const index = parseInt(document.getElementById('edit_index').value, 10);
            if (!Number.isFinite(index) || index < 0 || index >= allEntries.length) {
                throw new Error('Invalid entry index. Please reload the JSON and try again.');
            }

            allEntries[index] = {
                sr_no: document.getElementById('edit_sr_no').value,
                edition: document.getElementById('edit_edition').value,
                month: document.getElementById('edit_month').value,
                date: document.getElementById('edit_date').value,
                title: document.getElementById('edit_title').value,
                link: document.getElementById('edit_link').value,
                summary: document.getElementById('edit_summary').value,
                tag: document.getElementById('edit_tag').value
                    .split(',')
                    .map(t => t.trim())
                    .filter(t => t.length > 0),
                topic: document.getElementById('edit_topic').value.trim(),
                subtopic: document.getElementById('edit_subtopic').value.trim()
            };

            hasUnsavedChanges = true;
        }

        function saveEntry(e) {
            e.preventDefault();
            try {
                applyEditFormToEntry();
                closeEditModal();
                // Repopulate tag filters and side panel to include new tags
                populateTagFilter();
                // Rebuild topics panel to include new topics/subtopics
                buildTopicsPanel();
                // Re-filter and render to show updated entry with new tags
                filterEntries();
                console.log('Entry updated. Tag filters and side panel refreshed.');
            } catch (err) {
                console.error(err.message || String(err));
            }
        }
        
        function handleHeaderLoad(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    headerImageBase64 = e.target.result;
                    
                    // Extract dominant color from image
                    const img = new Image();
                    img.onload = () => {
                        headerBannerColor = extractDominantColor(img);
                    };
                    img.src = headerImageBase64;
                };
                reader.onerror = () => {
                    console.error('Error reading image file. Please try again.');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function extractDominantColor(img) {
            // Create a canvas to sample the image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Use a smaller sample size for performance
            const sampleSize = 50;
            canvas.width = sampleSize;
            canvas.height = sampleSize;
            
            // Draw image scaled down
            ctx.drawImage(img, 0, 0, sampleSize, sampleSize);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, sampleSize, sampleSize);
            const data = imageData.data;
            
            // Calculate average color (simple method)
            let r = 0, g = 0, b = 0, count = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                // Skip very light and very dark pixels
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                if (brightness > 30 && brightness < 225) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }
            }
            
            if (count === 0) count = 1; // Avoid division by zero
            
            return {
                r: Math.round(r / count),
                g: Math.round(g / count),
                b: Math.round(b / count)
            };
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for better table fit
            
            // Use loaded header image if available
            if (headerImageBase64) {
                const img = new Image();
                img.onload = async () => await generatePDF(doc, img);
                img.onerror = async () => await generatePDF(doc, null);
                img.src = headerImageBase64;
            } else {
                await generatePDF(doc, null);
            }
        }
        
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Image load failed'));
                img.src = src;
                setTimeout(() => reject(new Error('Image load timeout')), 3000);
            });
        }
        
        async function generatePDF(doc, img) {
            try {
                // Pre-load all emojis from the data
                const allEmojis = new Set();
                filteredEntries.forEach(entry => {
                    const titleEmojis = extractEmojis(entry.title || '');
                    const summaryEmojis = extractEmojis(cleanSummary(entry.summary || ''));
                    titleEmojis.forEach(e => allEmojis.add(e));
                    summaryEmojis.forEach(e => allEmojis.add(e));
                });
                
                // Load all emoji images
                if (allEmojis.size > 0) {
                    console.log('Loading', allEmojis.size, 'unique emojis...');
                    await Promise.all([...allEmojis].map(emoji => loadEmojiImage(emoji)));
                    console.log('Emojis loaded!');
                }
            } catch (error) {
                console.warn('Error loading emojis:', error);
            }
            
            // Set elegant Helvetica font for clean appearance
            doc.setFont('helvetica');
            
            // Helper function to determine if a color is light
            const isLightColor = (r, g, b) => {
                // Calculate relative luminance
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance > 0.6; // Return true if light
            };
            
            // Helper function to get appropriate text color based on background
            const getTextColor = (bgR, bgG, bgB) => {
                return isLightColor(bgR, bgG, bgB) ? [40, 40, 40] : [255, 255, 255];
            };
            
            let y = 10;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 10;
            
            // Calculate header band height based on image if provided
            let headerHeight = 25; // Default height
            let imgWidth = 0;
            let imgHeight = 0;
            
            if (img) {
                // Use original image dimensions (convert pixels to mm at 96 DPI)
                imgWidth = (img.width * 25.4) / 96;
                imgHeight = (img.height * 25.4) / 96;
                headerHeight = Math.max(25, imgHeight + 4); // At least 25mm or image height + 4mm padding
            }
            
            // Draw blue professional header band with calculated height
            doc.setFillColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
            doc.rect(0, 0, pageWidth, headerHeight, 'F');
            doc.setFontSize(24);
            const headerTextColor = getTextColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
            doc.setTextColor(headerTextColor[0], headerTextColor[1], headerTextColor[2]);
            doc.setFont('helvetica', 'bold');
            doc.text('ENAMOR INDEX', pageWidth / 2, 16, { align: 'center' });
            y = headerHeight + 3;
            
            // Overlay header image on top if provided
            if (img) {
                try {
                    // Center the image horizontally and vertically within the blue band
                    const xPos = (pageWidth - imgWidth) / 2;
                    const yPos = (headerHeight - imgHeight) / 2;
                    
                    doc.addImage(img, 'PNG', xPos, yPos, imgWidth, imgHeight, undefined, 'FAST');
                } catch (e) {
                    console.warn('Error adding image overlay:', e);
                    // Blue band already drawn, just continue
                }
            }
            
            // Statistics Section
            // Calculate statistics
            const maxSrNo = getMaxSrNo(allEntries);
            const totalEntries = allEntries.length;
            const filteredCount = filteredEntries.length;
            const latest = allEntries.find(e => parseInt(e?.sr_no, 10) === maxSrNo) || (allEntries.length > 0 ? allEntries[allEntries.length - 1] : null);
            
            const monthCounts = {};
            allEntries.forEach(entry => {
                if (entry.month) {
                    monthCounts[entry.month] = (monthCounts[entry.month] || 0) + 1;
                }
            });
            
            const totalMonths = Object.keys(monthCounts).length;
            const avgPerMonth = totalMonths > 0 ? (allEntries.length / totalMonths).toFixed(1) : 0;
            const thisMonthCount = latest ? (monthCounts[latest.month] || 0) : 0;
            
            // Create styled stat boxes
            const stats = [
                { label: 'Total Entries', value: totalEntries },
                { label: 'Filtered', value: filteredCount },
                { label: 'Latest Entry', value: maxSrNo ? `#${maxSrNo}` : 'N/A' },
                { label: 'Current Month', value: latest ? latest.month : 'N/A' },
                { label: 'Total Months', value: totalMonths },
                { label: 'Avg/Month', value: avgPerMonth },
                { label: 'This Month', value: thisMonthCount }
            ];
            
            const boxWidth = 38;
            const boxHeight = 14;
            const boxGap = 2;
            const startY = y;
            
            stats.forEach((stat, i) => {
                const row = Math.floor(i / 7);
                const col = i % 7;
                const x = margin + (col * (boxWidth + boxGap));
                const boxY = startY + (row * (boxHeight + boxGap));
                
                // Draw box with light background
                doc.setFillColor(248, 250, 252);
                doc.setDrawColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
                doc.setLineWidth(0.3);
                doc.roundedRect(x, boxY, boxWidth, boxHeight, 2, 2, 'FD');
                
                // Draw value (large)
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
                doc.text(String(stat.value), x + boxWidth / 2, boxY + 7, { align: 'center' });
                
                // Draw label (small)
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(stat.label, x + boxWidth / 2, boxY + 11, { align: 'center' });
            });
            
            y = startY + boxHeight + 6;
            
            // Separator line
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.2);
            doc.line(margin, y, pageWidth - margin, y);
            y += 6;
            
            // Table setup - Total width should be pageWidth - (2 * margin) = 277mm
            const totalWidth = pageWidth - (2 * margin);
            const colWidths = [15, 25, 22, 22, 50, 143];
            const startX = margin;
            const baseRowHeight = 7;
            const lineHeight = 3.2;
            
            // Get Twemoji CDN URL for an emoji
            function getTwemojiUrl(emoji) {
                const codePoints = [];
                for (const char of emoji) {
                    const code = char.codePointAt(0);
                    if (code) codePoints.push(code.toString(16));
                }
                return `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/${codePoints.join('-')}.png`;
            }
            
            // Cache for loaded emoji images
            const emojiImageCache = {};
            
            // Load emoji image and cache it
            function loadEmojiImage(emoji) {
                if (emojiImageCache[emoji]) {
                    return Promise.resolve(emojiImageCache[emoji]);
                }
                
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 72;
                        canvas.height = 72;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 72, 72);
                        const dataUrl = canvas.toDataURL('image/png');
                        emojiImageCache[emoji] = dataUrl;
                        resolve(dataUrl);
                    };
                    img.onerror = () => {
                        emojiImageCache[emoji] = null;
                        resolve(null);
                    };
                    img.src = getTwemojiUrl(emoji);
                });
            }
            
            // Extract all emojis from text
            function extractEmojis(text) {
                if (!text) return [];
                const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu;
                return [...text.matchAll(emojiRegex)].map(m => m[0]);
            }
            
            // Split text into segments of text and emojis
            function splitTextAndEmojis(text) {
                if (!text) return [];
                const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu;
                const parts = [];
                let lastIndex = 0;
                
                const matches = [...text.matchAll(emojiRegex)];
                matches.forEach(match => {
                    if (match.index > lastIndex) {
                        parts.push({ type: 'text', content: text.slice(lastIndex, match.index) });
                    }
                    parts.push({ type: 'emoji', content: match[0] });
                    lastIndex = match.index + match[0].length;
                });
                
                if (lastIndex < text.length) {
                    parts.push({ type: 'text', content: text.slice(lastIndex) });
                }
                
                return parts;
            }
            
            // Render text with inline emoji images
            function renderTextWithEmojis(doc, parts, xStart, y, maxWidth, fontSize = 7) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fontSize);
                
                const lines = [];
                let currentLine = [];
                let currentWidth = 0;
                const emojiSize = fontSize * 0.4; // Emoji size in mm
                const spaceWidth = doc.getTextWidth(' ');
                
                parts.forEach(part => {
                    if (part.type === 'text') {
                        const words = part.content.split(/\s+/);
                        words.forEach((word, idx) => {
                            if (!word) return;
                            
                            const wordWidth = doc.getTextWidth(word);
                            const addSpace = idx > 0 || currentLine.length > 0;
                            const testWidth = currentWidth + wordWidth + (addSpace ? spaceWidth : 0);
                            
                            if (testWidth > maxWidth && currentLine.length > 0) {
                                lines.push(currentLine);
                                currentLine = [{ type: 'text', content: word }];
                                currentWidth = wordWidth;
                            } else {
                                if (addSpace && currentLine.length > 0) {
                                    currentLine.push({ type: 'text', content: ' ' });
                                    currentWidth += spaceWidth;
                                }
                                currentLine.push({ type: 'text', content: word });
                                currentWidth += wordWidth;
                            }
                        });
                    } else if (part.type === 'emoji') {
                        const testWidth = currentWidth + emojiSize;
                        if (testWidth > maxWidth && currentLine.length > 0) {
                            lines.push(currentLine);
                            currentLine = [part];
                            currentWidth = emojiSize;
                        } else {
                            currentLine.push(part);
                            currentWidth += emojiSize;
                        }
                    }
                });
                
                if (currentLine.length > 0) {
                    lines.push(currentLine);
                }
                
                return lines;
            }
            
            // Convert emojis to text descriptions for PDF rendering
            function convertEmojisToText(text) {
                if (!text) return '';
                
                const emojiMap = {
                    'üòÄ': '[grinning]', 'üòÉ': '[grinning big]', 'üòÑ': '[smile]', 'üòÅ': '[beaming]',
                    'üòÜ': '[laughing]', 'üòÖ': '[sweat smile]', 'ü§£': '[rofl]', 'üòÇ': '[joy]',
                    'üôÇ': '[smile]', 'üôÉ': '[upside down]', 'üòâ': '[wink]', 'üòä': '[blush]',
                    'üòá': '[angel]', 'ü•∞': '[hearts]', 'üòç': '[heart eyes]', 'ü§©': '[star eyes]',
                    'üòò': '[kiss]', 'üòó': '[kissing]', 'üòö': '[kissing]', 'üòô': '[kissing smile]',
                    'üòã': '[yum]', 'üòõ': '[tongue]', 'üòú': '[wink tongue]', 'ü§™': '[zany]',
                    'üòù': '[squint tongue]', 'ü§ë': '[money mouth]', 'ü§ó': '[hugging]', 'ü§≠': '[hand over mouth]',
                    'ü§´': '[shushing]', 'ü§î': '[thinking]', 'ü§ê': '[zipper mouth]', 'ü§®': '[raised eyebrow]',
                    'üòê': '[neutral]', 'üòë': '[expressionless]', 'üò∂': '[no mouth]', 'üòè': '[smirk]',
                    'üòí': '[unamused]', 'üôÑ': '[eye roll]', 'üò¨': '[grimace]', 'ü§•': '[lying]',
                    'üòå': '[relieved]', 'üòî': '[pensive]', 'üò™': '[sleepy]', 'ü§§': '[drool]',
                    'üò¥': '[sleeping]', 'üò∑': '[mask]', 'ü§í': '[thermometer]', 'ü§ï': '[bandage]',
                    'ü§¢': '[nauseated]', 'ü§Æ': '[vomit]', 'ü§ß': '[sneeze]', 'ü•µ': '[hot]',
                    'ü•∂': '[cold]', 'üòµ': '[dizzy]', 'ü§Ø': '[mind blown]', 'ü•¥': '[woozy]',
                    'üòé': '[cool]', 'ü§ì': '[nerd]', 'üßê': '[monocle]', 'üòï': '[confused]',
                    'üòü': '[worried]', 'üôÅ': '[frown]', '‚òπÔ∏è': '[frown]', 'üòÆ': '[gasp]',
                    'üòØ': '[surprised]', 'üò≤': '[astonished]', 'üò≥': '[flushed]', 'ü•∫': '[pleading]',
                    'üò¶': '[frowning]', 'üòß': '[anguished]', 'üò®': '[fearful]', 'üò∞': '[anxious]',
                    'üò•': '[sad]', 'üò¢': '[crying]', 'üò≠': '[sobbing]', 'üò±': '[scream]',
                    'üòñ': '[confounded]', 'üò£': '[persevere]', 'üòû': '[disappointed]', 'üòì': '[downcast]',
                    'üò©': '[weary]', 'üò´': '[tired]', 'ü•±': '[yawn]', 'üò§': '[triumph]',
                    'üò°': '[angry]', 'üò†': '[mad]', 'ü§¨': '[cursing]', 'üòà': '[devil]',
                    'üëø': '[angry devil]', 'üíÄ': '[skull]', '‚ò†Ô∏è': '[skull bones]', 'üí©': '[poop]',
                    'ü§°': '[clown]', 'üëπ': '[ogre]', 'üë∫': '[goblin]', 'üëª': '[ghost]',
                    'üëΩ': '[alien]', 'üëæ': '[space invader]', 'ü§ñ': '[robot]', 'üéÉ': '[pumpkin]',
                    'üò∫': '[cat smile]', 'üò∏': '[cat grin]', 'üòπ': '[cat joy]', 'üòª': '[cat hearts]',
                    'üòº': '[cat smirk]', 'üòΩ': '[cat kiss]', 'üôÄ': '[cat scream]', 'üòø': '[cat cry]',
                    'üòæ': '[cat pout]', '‚ù§Ô∏è': '[heart]', 'üß°': '[orange heart]', 'üíõ': '[yellow heart]',
                    'üíö': '[green heart]', 'üíô': '[blue heart]', 'üíú': '[purple heart]', 'üñ§': '[black heart]',
                    'ü§ç': '[white heart]', 'ü§é': '[brown heart]', 'üíî': '[broken heart]', '‚ù£Ô∏è': '[heart exclamation]',
                    'üíï': '[two hearts]', 'üíû': '[revolving hearts]', 'üíì': '[beating heart]', 'üíó': '[growing heart]',
                    'üíñ': '[sparkling heart]', 'üíò': '[arrow heart]', 'üíù': '[heart box]', 'üíü': '[heart decoration]',
                    '‚òÆÔ∏è': '[peace]', '‚úùÔ∏è': '[cross]', '‚ò™Ô∏è': '[star crescent]', 'üïâÔ∏è': '[om]',
                    '‚ò∏Ô∏è': '[dharma]', '‚ú°Ô∏è': '[star of david]', 'üîØ': '[dotted six star]', 'üïé': '[menorah]',
                    '‚òØÔ∏è': '[yin yang]', '‚ò¶Ô∏è': '[orthodox cross]', 'üõê': '[worship]', '‚õé': '[ophiuchus]',
                    '‚ôà': '[aries]', '‚ôâ': '[taurus]', '‚ôä': '[gemini]', '‚ôã': '[cancer]',
                    '‚ôå': '[leo]', '‚ôç': '[virgo]', '‚ôé': '[libra]', '‚ôè': '[scorpio]',
                    '‚ôê': '[sagittarius]', '‚ôë': '[capricorn]', '‚ôí': '[aquarius]', '‚ôì': '[pisces]',
                    'üÜî': '[ID]', '‚öõÔ∏è': '[atom]', 'üâë': '[accept]', '‚ò¢Ô∏è': '[radioactive]',
                    '‚ò£Ô∏è': '[biohazard]', 'üì¥': '[mobile off]', 'üì≥': '[vibrate]', 'üÜö': '[vs]',
                    'üíÆ': '[white flower]', 'üâê': '[bargain]', '„äôÔ∏è': '[secret]', '„äóÔ∏è': '[congratulations]',
                    'üà¥': '[passing]', 'üàµ': '[full]', 'üàπ': '[discount]', 'üà≤': '[prohibited]',
                    'üÖ∞Ô∏è': '[A]', 'üÖ±Ô∏è': '[B]', 'üÜé': '[AB]', 'üÜë': '[CL]',
                    'üÖæÔ∏è': '[O]', 'üÜò': '[SOS]', '‚ùå': '[X]', '‚≠ï': '[O]',
                    'üõë': '[stop]', '‚õî': '[no entry]', 'üìõ': '[name badge]', 'üö´': '[prohibited]',
                    'üíØ': '[100]', 'üí¢': '[anger]', '‚ô®Ô∏è': '[hot springs]', 'üö∑': '[no pedestrians]',
                    'üöØ': '[no litter]', 'üö≥': '[no bikes]', 'üö±': '[no water]', 'üîû': '[18+]',
                    'üìµ': '[no phones]', 'üö≠': '[no smoking]', '‚ùó': '[!]', '‚ùï': '[!]',
                    '‚ùì': '[?]', '‚ùî': '[?]', '‚ÄºÔ∏è': '[!!]', '‚ÅâÔ∏è': '[!?]',
                    'üîÖ': '[dim]', 'üîÜ': '[bright]', '„ÄΩÔ∏è': '[part alternation]', '‚ö†Ô∏è': '[warning]',
                    'üö∏': '[children crossing]', 'üî±': '[trident]', '‚öúÔ∏è': '[fleur de lis]', 'üî∞': '[beginner]',
                    '‚ôªÔ∏è': '[recycle]', '‚úÖ': '[check]', 'üàØ': '[reserved]', 'üíπ': '[chart up]',
                    '‚ùáÔ∏è': '[sparkle]', '‚ú≥Ô∏è': '[*]', '‚ùé': '[x mark]', 'üåê': '[globe]',
                    'üí†': '[diamond]', '‚ìÇÔ∏è': '[M]', 'üåÄ': '[cyclone]', 'üí§': '[zzz]',
                    'üèß': '[ATM]', 'üöæ': '[WC]', '‚ôø': '[wheelchair]', 'üÖøÔ∏è': '[P]',
                    'üà≥': '[vacancy]', 'üàÇÔ∏è': '[sa]', 'üõÇ': '[passport]', 'üõÉ': '[customs]',
                    'üõÑ': '[baggage]', 'üõÖ': '[left luggage]', 'üöπ': '[men]', 'üö∫': '[women]',
                    'üöº': '[baby]', 'üöª': '[restroom]', 'üöÆ': '[litter bin]', 'üé¶': '[cinema]',
                    'üì∂': '[signal]', 'üàÅ': '[here]', 'üî£': '[symbols]', '‚ÑπÔ∏è': '[info]',
                    'üî§': '[abc]', 'üî°': '[abcd]', 'üî†': '[ABCD]', 'üÜñ': '[NG]',
                    'üÜó': '[OK]', 'üÜô': '[UP]', 'üÜí': '[COOL]', 'üÜï': '[NEW]',
                    'üÜì': '[FREE]', '0Ô∏è‚É£': '[0]', '1Ô∏è‚É£': '[1]', '2Ô∏è‚É£': '[2]',
                    '3Ô∏è‚É£': '[3]', '4Ô∏è‚É£': '[4]', '5Ô∏è‚É£': '[5]', '6Ô∏è‚É£': '[6]',
                    '7Ô∏è‚É£': '[7]', '8Ô∏è‚É£': '[8]', '9Ô∏è‚É£': '[9]', 'üîü': '[10]',
                    'üëç': '[thumbs up]', 'üëé': '[thumbs down]', 'üëå': '[ok hand]', '‚úåÔ∏è': '[peace]',
                    'ü§û': '[fingers crossed]', 'ü§ü': '[love you]', 'ü§ò': '[rock]', 'ü§ô': '[call me]',
                    'üëà': '[left]', 'üëâ': '[right]', 'üëÜ': '[up]', 'üëá': '[down]',
                    '‚òùÔ∏è': '[point up]', '‚úã': '[hand]', 'ü§ö': '[raised hand]', 'üñêÔ∏è': '[hand]',
                    'üññ': '[vulcan]', 'üëã': '[wave]', 'ü§ô': '[call]', 'üí™': '[muscle]',
                    'ü¶æ': '[mech arm]', 'üñï': '[middle finger]', '‚úçÔ∏è': '[writing]', 'üôè': '[pray]',
                    'ü¶∂': '[foot]', 'ü¶µ': '[leg]', 'ü¶∑': '[tooth]', 'ü¶¥': '[bone]',
                    'üëÄ': '[eyes]', 'üëÅÔ∏è': '[eye]', 'üëÖ': '[tongue]', 'üëÑ': '[lips]',
                    'üíã': '[kiss mark]', 'ü©∏': '[blood]', 'üë∂': '[baby]', 'üëß': '[girl]',
                    'üßí': '[child]', 'üë¶': '[boy]', 'üë©': '[woman]', 'üßë': '[person]',
                    'üë®': '[man]', 'üë©‚Äçü¶±': '[woman red hair]', 'üë®‚Äçü¶±': '[man red hair]', 'üë©‚Äçü¶∞': '[woman red hair]',
                    '‚ú®': '[sparkles]', '‚≠ê': '[star]', 'üåü': '[glowing star]', 'üí´': '[dizzy]',
                    'üî•': '[fire]', 'üí•': '[boom]', 'üí¶': '[sweat drops]', 'üí®': '[dash]',
                    'üåà': '[rainbow]', '‚òÄÔ∏è': '[sun]', 'üå§Ô∏è': '[sun cloud]', '‚õÖ': '[cloud sun]',
                    'üå•Ô∏è': '[cloud]', '‚òÅÔ∏è': '[cloud]', 'üå¶Ô∏è': '[sun rain]', 'üåßÔ∏è': '[rain]',
                    '‚õàÔ∏è': '[storm]', 'üå©Ô∏è': '[lightning]', 'üå®Ô∏è': '[snow]', '‚ùÑÔ∏è': '[snowflake]',
                    '‚òÉÔ∏è': '[snowman]', '‚õÑ': '[snowman]', 'üíß': '[droplet]', 'üí¶': '[sweat]',
                    'üåä': '[wave]', 'üéâ': '[party]', 'üéä': '[confetti]', 'üéà': '[balloon]',
                    'üéÅ': '[gift]', 'üéÄ': '[ribbon]', 'üéÇ': '[cake]', 'üç∞': '[shortcake]',
                    'üßÅ': '[cupcake]', 'ü•≥': '[party face]', 'üéØ': '[target]', 'üé≠': '[drama]',
                    'üé®': '[art]', 'üé¨': '[clapper]', 'üé§': '[mic]', 'üéß': '[headphone]',
                    'üéº': '[music]', 'üéπ': '[piano]', 'ü•Å': '[drum]', 'üé∑': '[sax]',
                    'üé∫': '[trumpet]', 'üé∏': '[guitar]', 'ü™ï': '[banjo]', 'üéª': '[violin]',
                    'üé≤': '[dice]', '‚ôüÔ∏è': '[pawn]', 'üé≥': '[bowling]', 'üéÆ': '[game]',
                    'üé∞': '[slot]', 'üß©': '[puzzle]', 'üöó': '[car]', 'üöï': '[taxi]',
                    'üöô': '[SUV]', 'üöå': '[bus]', 'üöé': '[trolley]', 'üèéÔ∏è': '[race car]',
                    'üöì': '[police]', 'üöë': '[ambulance]', 'üöí': '[fire truck]', 'üöê': '[minibus]',
                    'üõª': '[pickup]', 'üöö': '[truck]', 'üöõ': '[semi]', 'üöú': '[tractor]',
                    'üèçÔ∏è': '[motorcycle]', 'üõµ': '[scooter]', 'üö≤': '[bike]', 'üõ¥': '[kick scooter]',
                    '‚úàÔ∏è': '[plane]', 'üõ©Ô∏è': '[small plane]', 'üõ´': '[takeoff]', 'üõ¨': '[landing]',
                    'üöÄ': '[rocket]', 'üõ∏': '[UFO]', 'üöÅ': '[helicopter]', 'üõ∂': '[canoe]',
                    '‚õµ': '[sailboat]', 'üö§': '[speedboat]', 'üõ•Ô∏è': '[motor boat]', 'üõ≥Ô∏è': '[ship]',
                    '‚öì': '[anchor]', 'ü™ù': '[hook]', '‚õΩ': '[fuel]', 'üöß': '[construction]',
                    'üö¶': '[traffic light]', 'üö•': '[light]', 'üèÅ': '[checkered flag]', 'üéå': '[crossed flags]',
                    '‚öΩ': '[soccer]', '‚öæ': '[baseball]', 'ü•é': '[softball]', 'üèÄ': '[basketball]',
                    'üèê': '[volleyball]', 'üèà': '[football]', 'üèâ': '[rugby]', 'üéæ': '[tennis]',
                    'ü•è': '[frisbee]', 'üé≥': '[bowling]', 'üèè': '[cricket]', 'üèë': '[field hockey]',
                    'üèí': '[ice hockey]', 'ü•ç': '[lacrosse]', 'üèì': '[ping pong]', 'üè∏': '[badminton]',
                    'ü•ä': '[boxing]', 'ü•ã': '[martial arts]', 'ü•Ö': '[goal]', '‚õ≥': '[golf]',
                    '‚õ∏Ô∏è': '[skate]', 'üé£': '[fishing]', 'ü§ø': '[diving]', 'üéΩ': '[running shirt]',
                    'üéø': '[ski]', 'üõ∑': '[sled]', 'ü•å': '[curling]', 'üéØ': '[bullseye]',
                    'ü™Ä': '[yoyo]', 'ü™Å': '[kite]', 'üé±': '[8ball]', 'üîÆ': '[crystal ball]',
                    'ü™Ñ': '[wand]', 'üßø': '[nazar]', 'üéÆ': '[controller]', 'üïπÔ∏è': '[joystick]',
                    'üé∞': '[slots]', 'üé≤': '[dice]', 'üß©': '[puzzle piece]', 'üß∏': '[teddy]',
                    'ü™Ö': '[pinata]', 'ü™Ü': '[nesting dolls]', '‚ô†Ô∏è': '[spade]', '‚ô•Ô∏è': '[heart]',
                    '‚ô¶Ô∏è': '[diamond]', '‚ô£Ô∏è': '[club]', '‚ôüÔ∏è': '[chess]', 'üÉè': '[joker]',
                    'üÄÑ': '[mahjong]', 'üé¥': '[flower cards]', 'üé≠': '[theater]', 'üñºÔ∏è': '[frame]',
                    'üé®': '[palette]', 'üßµ': '[thread]', 'ü™°': '[needle]', 'üß∂': '[yarn]',
                    'üìö': '[books]', 'üìñ': '[book]', 'üìï': '[red book]', 'üìó': '[green book]',
                    'üìò': '[blue book]', 'üìô': '[orange book]', 'üìì': '[notebook]', 'üìî': '[book]',
                    'üìí': '[ledger]', 'üìÉ': '[page]', 'üìú': '[scroll]', 'üìÑ': '[page]',
                    'üì∞': '[newspaper]', 'üóûÔ∏è': '[paper]', 'üìë': '[bookmark]', 'üîñ': '[bookmark]',
                    'üè∑Ô∏è': '[label]', 'üí∞': '[money bag]', 'üí¥': '[yen]', 'üíµ': '[dollar]',
                    'üí∂': '[euro]', 'üí∑': '[pound]', 'üí∏': '[money wings]', 'üí≥': '[card]',
                    'üßæ': '[receipt]', 'üíπ': '[chart]', 'üí±': '[exchange]', 'üí≤': '[$]',
                    '‚úâÔ∏è': '[envelope]', 'üìß': '[email]', 'üì®': '[incoming]', 'üì©': '[envelope arrow]',
                    'üì§': '[outbox]', 'üì•': '[inbox]', 'üì¶': '[package]', 'üì´': '[mailbox]',
                    'üì™': '[mailbox down]', 'üì¨': '[mailbox up]', 'üì≠': '[mailbox no mail]', 'üìÆ': '[postbox]',
                    'üó≥Ô∏è': '[ballot]', '‚úèÔ∏è': '[pencil]', '‚úíÔ∏è': '[pen]', 'üñãÔ∏è': '[fountain pen]',
                    'üñäÔ∏è': '[pen]', 'üñåÔ∏è': '[brush]', 'üñçÔ∏è': '[crayon]', 'üìù': '[memo]',
                    'üíº': '[briefcase]', 'üìÅ': '[folder]', 'üìÇ': '[open folder]', 'üóÇÔ∏è': '[dividers]',
                    'üìÖ': '[calendar]', 'üìÜ': '[calendar]', 'üóíÔ∏è': '[notepad]', 'üóìÔ∏è': '[calendar]',
                    'üìá': '[card index]', 'üìà': '[chart up]', 'üìâ': '[chart down]', 'üìä': '[bar chart]',
                    'üìã': '[clipboard]', 'üìå': '[pin]', 'üìç': '[pin]', 'üìé': '[paperclip]',
                    'üñáÔ∏è': '[linked clips]', 'üìè': '[ruler]', 'üìê': '[triangle]', '‚úÇÔ∏è': '[scissors]',
                    'üóÉÔ∏è': '[card box]', 'üóÑÔ∏è': '[filing cabinet]', 'üóëÔ∏è': '[trash]', 'üîí': '[locked]',
                    'üîì': '[unlocked]', 'üîè': '[locked pen]', 'üîê': '[locked key]', 'üîë': '[key]',
                    'üóùÔ∏è': '[old key]', 'üî®': '[hammer]', 'ü™ì': '[axe]', '‚õèÔ∏è': '[pick]',
                    '‚öíÔ∏è': '[hammer pick]', 'üõ†Ô∏è': '[tools]', 'üó°Ô∏è': '[dagger]', '‚öîÔ∏è': '[crossed swords]',
                    'üî´': '[pistol]', 'ü™É': '[boomerang]', 'üèπ': '[bow]', 'üõ°Ô∏è': '[shield]',
                    'ü™ö': '[saw]', 'üîß': '[wrench]', 'ü™õ': '[screwdriver]', 'üî©': '[nut]',
                    '‚öôÔ∏è': '[gear]', 'üóúÔ∏è': '[clamp]', '‚öñÔ∏è': '[scale]', 'ü¶Ø': '[cane]',
                    'üîó': '[link]', '‚õìÔ∏è': '[chains]', 'ü™ù': '[hook]', 'üß∞': '[toolbox]',
                    'üß≤': '[magnet]', 'ü™ú': '[ladder]', '‚öóÔ∏è': '[alembic]', 'üß™': '[test tube]',
                    'üß´': '[petri]', 'üß¨': '[DNA]', 'üî¨': '[microscope]', 'üî≠': '[telescope]',
                    'üì°': '[satellite]', 'üíâ': '[syringe]', 'ü©∏': '[blood drop]', 'üíä': '[pill]',
                    'ü©π': '[bandaid]', 'ü©∫': '[stethoscope]', 'üö™': '[door]', 'üõó': '[elevator]',
                    'ü™û': '[mirror]', 'ü™ü': '[window]', 'üõèÔ∏è': '[bed]', 'üõãÔ∏è': '[couch]',
                    'ü™ë': '[chair]', 'üöΩ': '[toilet]', 'ü™†': '[plunger]', 'üöø': '[shower]',
                    'üõÅ': '[bathtub]', 'ü™§': '[trap]', 'ü™í': '[razor]', 'üß¥': '[lotion]',
                    'üß∑': '[safety pin]', 'üßπ': '[broom]', 'üß∫': '[basket]', 'üßª': '[toilet paper]',
                    'ü™£': '[bucket]', 'üßº': '[soap]', 'ü™•': '[toothbrush]', 'üßΩ': '[sponge]',
                    'üßØ': '[extinguisher]', 'üõí': '[cart]', 'üö¨': '[cigarette]', '‚ö∞Ô∏è': '[coffin]',
                    'ü™¶': '[headstone]', '‚ö±Ô∏è': '[urn]', 'üóø': '[moai]', 'ü™ß': '[placard]'
                };
                
                let result = String(text);
                
                // Replace known emojis
                for (const [emoji, replacement] of Object.entries(emojiMap)) {
                    result = result.split(emoji).join(replacement);
                }
                
                // Replace any remaining emojis with generic placeholder
                result = result.replace(/[\u{1F300}-\u{1F9FF}|\u{2600}-\u{26FF}|\u{2700}-\u{27BF}]/gu, '[emoji]');
                
                return result;
            }
            
            // Manual word wrapping function - builds lines word by word
            function wrapText(text, maxWidth, fontSize = 7) {
                if (!text) return [''];
                
                // Convert emojis to text before processing
                text = convertEmojisToText(text);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fontSize);
                
                const words = String(text).split(/\s+/);
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    let word = words[i];
                    
                    // If word itself is too long, break it
                    while (doc.getTextWidth(word) > maxWidth) {
                        let chunk = '';
                        for (let j = 0; j < word.length; j++) {
                            const testChunk = chunk + word[j];
                            if (doc.getTextWidth(testChunk) > maxWidth) {
                                if (chunk) {
                                    if (currentLine) {
                                        lines.push(currentLine);
                                        currentLine = '';
                                    }
                                    lines.push(chunk);
                                }
                                chunk = word[j];
                            } else {
                                chunk = testChunk;
                            }
                        }
                        word = chunk;
                    }
                    
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    const testWidth = doc.getTextWidth(testLine);
                    
                    if (testWidth > maxWidth) {
                        if (currentLine) {
                            lines.push(currentLine);
                        }
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                return lines.length > 0 ? lines : [''];
            }

            function drawTableRow(entry, yPos, isHeader = false, stripeIndex = 0) {
                let xPos = startX;
                const rowTop = yPos - 5;
                
                if (isHeader) {
                    // Table header row: use extracted banner color
                    doc.setFillColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
                    doc.rect(startX, rowTop, pageWidth - (2 * margin), baseRowHeight, 'F');
                    // Force white text for header band
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    
                    // Header text - centered
                    const headers = ['Sr No', 'Edition', 'Month', 'Date', 'Title', 'Summary'];
                    headers.forEach((text, i) => {
                        doc.text(text, xPos + (colWidths[i] / 2), yPos, { align: 'center' });
                        doc.setDrawColor(200, 200, 200);
                        doc.rect(xPos, rowTop, colWidths[i], baseRowHeight);
                        xPos += colWidths[i];
                    });
                    return baseRowHeight;
                } else {
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    
                    // Draw cells
                    const data = [
                        entry.sr_no,
                        entry.edition,
                        entry.month,
                        entry.date,
                        entry.title,
                        cleanSummary(entry.summary) // Clean summary before display
                    ];

                    // Use manual wrapping with proper width calculation
                    const wrappedByCol = data.map((text, i) => {
                        const cellPadding = 6; // Extra padding
                        const cellWidth = colWidths[i] - cellPadding;
                        return wrapText(text, cellWidth, 7);
                    });
                    
                    const maxLines = Math.max(1, ...wrappedByCol.map(lines => (lines?.length || 1)));
                    const rowHeight = baseRowHeight + (maxLines - 1) * lineHeight;

                    // Alternating row colors
                    if (stripeIndex % 2 === 0) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(startX, rowTop, pageWidth - (2 * margin), rowHeight, 'F');
                    }
                    
                    wrappedByCol.forEach((lines, i) => {
                        const safeLines = Array.isArray(lines) ? lines : [String(lines || '')];
                        
                        // Draw wrapped text lines within the cell
                        for (let li = 0; li < safeLines.length; li++) {
                            const lineText = String(safeLines[li] || '');
                            const lineY = yPos + (li * lineHeight);

                            const isSummaryCol = i === 5;
                            const cellCenterX = xPos + (colWidths[i] / 2);

                            // Center all columns except Summary
                            if (!isSummaryCol) {
                                // Title column: blue + clickable link (first line)
                                if (i === 4 && entry.link) {
                                    doc.setTextColor(30, 64, 175); // Blue color
                                    doc.text(lineText, cellCenterX, lineY, { align: 'center' });

                                    // Make first line clickable while keeping centered layout
                                    if (li === 0) {
                                        const textWidth = doc.getTextWidth(lineText);
                                        const linkX = cellCenterX - (textWidth / 2);
                                        // Roughly cover the text line height
                                        doc.link(linkX, lineY - 2.8, textWidth, 3.6, { url: entry.link });
                                    }
                                    doc.setTextColor(0, 0, 0); // Reset to black
                                } else {
                                    doc.text(lineText, cellCenterX, lineY, { align: 'center' });
                                }
                            } else {
                                // Summary stays left-aligned with padding
                                doc.text(lineText, xPos + 2, lineY);
                            }
                        }

                        // Draw cell border
                        doc.setDrawColor(200, 200, 200);
                        doc.rect(xPos, rowTop, colWidths[i], rowHeight);

                        xPos += colWidths[i];
                    });

                    return rowHeight;
                }
            }
            
            // Group entries by month
            const entriesByMonth = {};
            filteredEntries.forEach(entry => {
                const month = entry.month || 'Unknown';
                if (!entriesByMonth[month]) {
                    entriesByMonth[month] = [];
                }
                entriesByMonth[month].push(entry);
            });
            
            // Sort entries by date within each month
            Object.keys(entriesByMonth).forEach(month => {
                entriesByMonth[month].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
            });
            
            // Sort months chronologically
            const parseMonthYear = (monthYear) => {
                const [month, year] = monthYear.split(' ');
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'June': 5, 'Jul': 6, 'July': 6, 'Aug': 7, 'Sep': 8, 'Sept': 8,
                    'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                return new Date(parseInt(year), monthMap[month] || 0);
            };
            
            const sortedMonths = Object.keys(entriesByMonth).sort((a, b) => {
                return parseMonthYear(a) - parseMonthYear(b);
            });
            
            // Draw header
            y += drawTableRow(null, y, true);
            
            // Draw data rows grouped by month
            sortedMonths.forEach((month, monthIndex) => {
                const monthEntries = entriesByMonth[month];
                
                // Draw month separator
                if (y > pageHeight - 20) {
                    doc.addPage();
                    y = 15;
                    y += drawTableRow(null, y, true);
                }
                
                // Month header row (group heading): derived from extracted banner color
                const monthBgR = Math.min(255, headerBannerColor.r + 20);
                const monthBgG = Math.min(255, headerBannerColor.g + 20);
                const monthBgB = Math.min(255, headerBannerColor.b + 20);
                doc.setFillColor(monthBgR, monthBgG, monthBgB);
                doc.rect(startX, y - 5, pageWidth - (2 * margin), baseRowHeight, 'F');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                // Force grey text for month group band
                doc.setTextColor(110, 110, 110);
                doc.text(`Month ${monthIndex + 1} - ${month} (${monthEntries.length} entries)`, startX + 2, y);
                y += baseRowHeight;
                
                // Draw entries for this month
                let stripeIndex = 0;
                monthEntries.forEach((entry) => {
                    // Pre-calculate row height to check if it fits on current page
                    const tempData = [
                        entry.sr_no,
                        entry.edition,
                        entry.month,
                        entry.date,
                        entry.title,
                        cleanSummary(entry.summary)
                    ];
                    
                    const tempWrapped = tempData.map((text, i) => {
                        const cellPadding = 6;
                        const cellWidth = colWidths[i] - cellPadding;
                        const parts = splitTextAndEmojis(String(text || ''));
                        return renderTextWithEmojis(doc, parts, 0, 0, cellWidth, 7);
                    });
                    
                    const tempMaxLines = Math.max(1, ...tempWrapped.map(lines => (lines?.length || 1)));
                    const estimatedRowHeight = baseRowHeight + (tempMaxLines - 1) * lineHeight;
                    
                    // Check if row will fit on current page (with margin for safety)
                    if (y + estimatedRowHeight > pageHeight - 15) {
                        doc.addPage();
                        y = 15;
                        // Redraw header on new page
                        y += drawTableRow(null, y, true);
                    }
                    
                    const usedHeight = drawTableRow(entry, y, false, stripeIndex);
                    stripeIndex++;
                    y += usedHeight;
                });
            });
            
            // Add footer to all pages
            const totalPages = doc.internal.getNumberOfPages();
            const exportDate = new Date().toLocaleDateString();
            
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // Footer background bar
                const footerY = pageHeight - 8;
                doc.setFillColor(headerBannerColor.r, headerBannerColor.g, headerBannerColor.b);
                doc.rect(margin, footerY, pageWidth - (2 * margin), 5, 'F');
                
                // Footer text - white on colored background, all bold
                doc.setFontSize(8);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                
                // Exported date (left)
                doc.text(`Exported: ${exportDate}`, margin + 2, footerY + 3.5);
                
                // Page number (right)
                doc.text(`Page ${i} / ${totalPages}`, pageWidth - margin - 2, footerY + 3.5, { align: 'right' });
            }
            
            doc.save(`enamor-index-${new Date().toISOString().split('T')[0]}.pdf`);
        }


    </script>
</body>
</html>
