<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhagavad Gita - Sacred Wisdom</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 50%, #c4b5fd 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .header {
            text-align: center;
            color: #5b21b6;
            margin-bottom: 30px;
            padding: 25px 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(91, 33, 182, 0.15);
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(91, 33, 182, 0.2);
            font-family: 'Crimson Text', serif;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.85;
            font-style: italic;
            font-family: 'Crimson Text', serif;
            font-weight: 400;
            color: #6d28d9;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.7);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(91, 33, 182, 0.2);
            border: 1px solid rgba(196, 181, 253, 0.5);
        }

        .search-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-box input,
        .search-box select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
            outline: none;
        }

        .search-box input:focus,
        .search-box select:focus {
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .stat-item {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 2px solid #e9d5ff;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(91, 33, 182, 0.1);
            transition: all 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 33, 182, 0.15);
        }

        .stat-item span {
            font-weight: 600;
            color: #6d28d9;
        }

        .stat-item strong {
            color: #7c3aed;
            font-weight: 700;
        }

        .show-all-btn {
            background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
            color: #5b21b6;
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
        }

        .show-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(167, 139, 250, 0.5);
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .upload-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
        }

        #fileInput {
            display: none;
        }

        .grid-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chapter-section {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(196, 181, 253, 0.5);
            box-shadow: 0 4px 20px rgba(91, 33, 182, 0.15);
        }

        .chapter-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: #5b21b6;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(167, 139, 250, 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chapter-count {
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(167, 139, 250, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            color: #6d28d9;
        }

        .shlokas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .shloka-card {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
            height: fit-content;
        }

        .shloka-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .shloka-card.expanded {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #ddd6fe 0%, #e9d5ff 100%);
            color: #5b21b6;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .card-header:hover {
            background: linear-gradient(135deg, #c4b5fd 0%, #ddd6fe 100%);
        }

        .card-header-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 16px;
            overflow: hidden;
        }

        .card-header .sr-number {
            background: rgba(91, 33, 182, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            color: #5b21b6;
        }

        .card-header-summary {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }

        .card-header-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .header-tag {
            background: rgba(91, 33, 182, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #5b21b6;
        }

        .header-tag:hover {
            background: rgba(91, 33, 182, 0.3);
            transform: scale(1.05);
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .shloka-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .card-body {
            display: none;
            padding: 20px 16px;
            gap: 16px;
            background: linear-gradient(to bottom, #ffffff 0%, #faf5ff 100%);
            border-top: 2px solid #e9d5ff;
            flex-direction: column;
        }

        .shloka-card.expanded .card-body {
            display: flex;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .shloka-visual {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 8px;
            width: 100%;
        }

        .quadrant {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-family: 'Noto Sans Devanagari', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.5;
            color: #78350f;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            word-break: break-word;
            overflow: hidden;
            border: 1px solid rgba(251, 191, 36, 0.2);
            min-height: 60px;
        }

        .quadrant.line1 {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #1e3a8a;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .quadrant.line2 {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #78350f;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .card-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .summary {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.6;
            margin-bottom: 4px;
            font-family: 'Inter', sans-serif;
        }

        .details {
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.6;
            text-align: left;
            font-family: 'Inter', sans-serif;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .tag {
            background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: lowercase;
            box-shadow: 0 2px 4px rgba(167, 139, 250, 0.3);
            transition: all 0.2s;
            cursor: pointer;
        }

        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(167, 139, 250, 0.4);
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        .notes-section {
            display: none;
            border-top: 1px solid #e9d5ff;
            padding: 24px 28px;
            background: #faf5ff;
        }

        .shloka-card.expanded .notes-section {
            display: block;
        }

        .notes-label {
            font-weight: 700;
            color: #6d28d9;
            margin-bottom: 10px;
            margin-top: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .notes-input {
            width: 100%;
            min-height: 80px;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s;
            background: white;
        }

        .notes-input:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.15);
        }

        .audio-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-top: 2px solid #f0f0f0;
        }

        .audio-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .audio-player {
            flex: 1;
        }

        .audio-player audio {
            width: 100%;
            height: 35px;
        }

        .audio-link {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            padding: 8px 15px;
            border-radius: 20px;
            background: white;
        }

        .audio-link:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .audio-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .audio-url-input {
            flex: 1;
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9rem;
            font-family: 'Crimson Text', serif;
        }

        .audio-url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .save-audio-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .save-audio-btn:hover {
            transform: scale(1.05);
        }

        .no-results {
            text-align: center;
            color: #5b21b6;
            font-size: 1.5rem;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }

            .grid-container {
                padding: 10px;
            }

            .card-body {
                flex-direction: column;
            }

            .left-section {
                flex: 0 0 auto;
                width: 100%;
            }

            .card-header-summary {
                white-space: normal;
            }

            .card-header-tags {
                display: none;
            }
        }

        .loading {
            text-align: center;
            color: #5b21b6;
            font-size: 1.5rem;
            padding: 60px 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üïâÔ∏è Bhagavad Gita</h1>
        <div class="subtitle">The Song of the Divine - Sacred Wisdom for Life</div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchText" placeholder="Search in details, summary, tags..." />
            <select id="chapterFilter">
                <option value="">All Chapters</option>
            </select>
            <select id="tagFilter">
                <option value="">All Tags</option>
            </select>
            <input type="text" id="shlokaNumber" placeholder="Shloka number (e.g., 2-47)" />
        </div>
        <div class="stats">
            <div class="stat-item">
                <span>Total Shlokas:</span>
                <strong id="totalCount">0</strong>
            </div>
            <div class="stat-item">
                <span>Displayed:</span>
                <strong id="displayedCount">0</strong>
            </div>
            <div class="stat-item">
                <span>Chapters:</span>
                <strong id="chapterCount">18</strong>
            </div>
            <button class="show-all-btn" onclick="clearAllFilters()">Show All</button>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload JSON file">üì§ Upload</button>
            <button class="download-btn" onclick="downloadJSON()" title="Download JSON with your notes">üíæ Download</button>
            <input type="file" id="fileInput" accept=".json" onchange="uploadJSON(event)">
        </div>
    </div>

    <div id="loading" class="loading">Loading sacred wisdom...</div>
    <div id="gridContainer" class="grid-container" style="display: none;"></div>
    <div id="noResults" class="no-results" style="display: none;">
        No shlokas found matching your search criteria. üôè
    </div>


    </div>

    <script>
        let allShlokas = [];
        let filteredShlokas = [];

        // Load the JSON data
        async function loadData() {
            try {
                const response = await fetch('gita.json');
                const data = await response.json();
                allShlokas = data.shlokas;
                filteredShlokas = allShlokas;
                
                // Populate chapter filter
                const chapters = [...new Set(allShlokas.map(s => s.chapter))].sort((a, b) => a - b);
                const chapterFilter = document.getElementById('chapterFilter');
                chapters.forEach(ch => {
                    const option = document.createElement('option');
                    option.value = ch;
                    option.textContent = `Chapter ${ch}`;
                    chapterFilter.appendChild(option);
                });
                
                // Populate tag filter
                const allTags = [...new Set(allShlokas.flatMap(s => s.tags))].sort();
                const tagFilter = document.getElementById('tagFilter');
                allTags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    tagFilter.appendChild(option);
                });
                
                // Load saved notes from localStorage
                loadSavedNotes();
                
                document.getElementById('totalCount').textContent = allShlokas.length;
                document.getElementById('loading').style.display = 'none';
                renderShlokas();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 'Error loading data. Please refresh the page.';
            }
        }

        // Split shloka into parts for quadrants
        function splitShlokaText(shlokaText) {
            // Remove speaker introductions like "‡§ß‡•É‡§§‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§â‡§µ‡§æ‡§ö‡•§", "‡§Ö‡§∞‡•ç‡§ú‡•Å‡§® ‡§â‡§µ‡§æ‡§ö‡•§", "‡§∂‡•ç‡§∞‡•Ä ‡§≠‡§ó‡§µ‡§æ‡§®‡•ç ‡§â‡§µ‡§æ‡§ö‡•§" etc.
            let cleanedText = shlokaText.replace(/^[^‡•§]*‡§â‡§µ‡§æ‡§ö‡•§\s*/u, '').trim();
            
            // Remove the verse number at the end (e.g., ‡••‡•®-‡•™‡•≠‡••)
            cleanedText = cleanedText.replace(/‡••.*?‡••$/, '').trim();
            
            // Split into words, ignoring dandas
            const allWords = cleanedText.replace(/‡•§/g, ' ').split(/\s+/).filter(w => w.length > 0);
            const totalWords = allWords.length;
            
            // Ensure minimum 2 words per quadrant
            const minWordsPerQuadrant = 2;
            
            // If less than 8 words total, distribute what we have
            if (totalWords < 8) {
                const wordsPerQuadrant = Math.max(1, Math.floor(totalWords / 4));
                const quadrants = [];
                let startIdx = 0;
                
                for (let i = 0; i < 4; i++) {
                    const endIdx = (i === 3) ? totalWords : Math.min(startIdx + wordsPerQuadrant, totalWords);
                    quadrants.push(allWords.slice(startIdx, endIdx).join(' '));
                    startIdx = endIdx;
                }
                
                // Fill empty quadrants by redistributing
                const nonEmpty = quadrants.filter(q => q.trim().length > 0);
                if (nonEmpty.length < 4 && nonEmpty.length > 0) {
                    // Redistribute all words evenly
                    const perQuad = Math.ceil(totalWords / 4);
                    return {
                        quadrants: [
                            allWords.slice(0, perQuad).join(' ') || allWords[0] || '',
                            allWords.slice(perQuad, perQuad * 2).join(' ') || allWords[1] || '',
                            allWords.slice(perQuad * 2, perQuad * 3).join(' ') || allWords[2] || '',
                            allWords.slice(perQuad * 3).join(' ') || allWords[3] || ''
                        ]
                    };
                }
                
                return { quadrants };
            }
            
            // Calculate words per quadrant ensuring minimum of 2
            const wordsPerQuadrant = Math.max(minWordsPerQuadrant, Math.floor(totalWords / 4));
            
            // Distribute words evenly across 4 quadrants
            const q1End = wordsPerQuadrant;
            const q2End = wordsPerQuadrant * 2;
            const q3End = wordsPerQuadrant * 3;
            
            const quadrants = [
                allWords.slice(0, q1End).join(' '),
                allWords.slice(q1End, q2End).join(' '),
                allWords.slice(q2End, q3End).join(' '),
                allWords.slice(q3End).join(' ')
            ];
            
            // Verify no quadrant is empty and redistribute if needed
            const hasEmpty = quadrants.some(q => !q || q.trim().length === 0);
            if (hasEmpty && totalWords >= 8) {
                // Force even distribution
                const perQuad = Math.floor(totalWords / 4);
                const remainder = totalWords % 4;
                
                return {
                    quadrants: [
                        allWords.slice(0, perQuad + (remainder > 0 ? 1 : 0)).join(' '),
                        allWords.slice(perQuad + (remainder > 0 ? 1 : 0), perQuad * 2 + (remainder > 1 ? 1 : 0)).join(' '),
                        allWords.slice(perQuad * 2 + (remainder > 1 ? 1 : 0), perQuad * 3 + (remainder > 2 ? 1 : 0)).join(' '),
                        allWords.slice(perQuad * 3 + (remainder > 2 ? 1 : 0)).join(' ')
                    ]
                };
            }
            
            return { quadrants };
        }

        // Render shlokas
        function renderShlokas() {
            const container = document.getElementById('gridContainer');
            const noResults = document.getElementById('noResults');
            
            container.innerHTML = '';
            
            if (filteredShlokas.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                document.getElementById('displayedCount').textContent = '0';
                return;
            }
            
            container.style.display = 'block';
            noResults.style.display = 'none';
            document.getElementById('displayedCount').textContent = filteredShlokas.length;
            
            // Group shlokas by chapter
            const chapterMap = new Map();
            filteredShlokas.forEach(shloka => {
                if (!chapterMap.has(shloka.chapter)) {
                    chapterMap.set(shloka.chapter, []);
                }
                chapterMap.get(shloka.chapter).push(shloka);
            });
            
            // Create chapters grid container
            const chaptersGrid = document.createElement('div');
            chaptersGrid.className = 'chapters-grid';
            
            // Sort chapters and render each
            Array.from(chapterMap.keys()).sort((a, b) => a - b).forEach(chapterNum => {
                const shlokas = chapterMap.get(chapterNum);
                
                // Create chapter section
                const chapterSection = document.createElement('div');
                chapterSection.className = 'chapter-section';
                
                // Create chapter header
                const chapterHeader = document.createElement('div');
                chapterHeader.className = 'chapter-header';
                chapterHeader.innerHTML = `
                    <span>Chapter ${chapterNum}</span>
                    <span class="chapter-count">${shlokas.length} shlokas</span>
                `;
                chapterSection.appendChild(chapterHeader);
                
                // Create shlokas grid
                const shlokasGrid = document.createElement('div');
                shlokasGrid.className = 'shlokas-grid';
                
                shlokas.forEach(shloka => {
                    const card = createShlokaCard(shloka);
                    shlokasGrid.appendChild(card);
                });
                
                chapterSection.appendChild(shlokasGrid);
                chaptersGrid.appendChild(chapterSection);
            });
            
            container.appendChild(chaptersGrid);
        }

        // Create shloka card
        function createShlokaCard(shloka) {
            const card = document.createElement('div');
            card.className = 'shloka-card';
            
            const { quadrants } = splitShlokaText(shloka.shloka);
            
            card.innerHTML = `
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <div class="sr-number">#${shloka['sr#']}</div>
                        <div class="card-header-summary">${shloka.summary}</div>
                        <div class="card-header-tags">
                            ${shloka.tags.slice(0, 3).map(tag => `<span class="header-tag" onclick="event.stopPropagation(); filterByTag('${tag}')">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="expand-icon">‚ñº</div>
                </div>
                <div class="card-body">
                    <div class="left-section">
                        <div class="shloka-visual">
                            <div class="quadrant line1">${quadrants[0] || ''}</div>
                            <div class="quadrant line1">${quadrants[1] || ''}</div>
                            <div class="quadrant line2">${quadrants[2] || ''}</div>
                            <div class="quadrant line2">${quadrants[3] || ''}</div>
                        </div>
                        <div class="tags">
                            ${shloka.tags.map(tag => `<span class="tag" onclick="event.stopPropagation(); filterByTag('${tag}')">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="summary">${shloka.summary}</div>
                        <div class="details">${shloka.details}</div>
                    </div>
                </div>
                <div class="notes-section">
                    <div class="notes-label">Personal Notes:</div>
                    <textarea class="notes-input" placeholder="Add your personal reflections and insights here..." 
                              data-sr="${shloka['sr#']}"
                              onchange="saveNote(this)">${shloka.notes}</textarea>
                </div>
            `;
            
            return card;
        }

        // Save audio URL
        function saveAudio(srNumber) {
            const input = document.querySelector(`.audio-url-input[data-sr="${srNumber}"]`);
            const audioUrl = input.value.trim();
            
            // Find and update the shloka
            const shloka = allShlokas.find(s => s['sr#'] === srNumber);
            if (shloka) {
                shloka.audio = audioUrl;
                
                // Save to localStorage
                localStorage.setItem('gitaAudio', JSON.stringify(allShlokas));
                
                // Visual feedback
                input.style.borderColor = '#4CAF50';
                setTimeout(() => {
                    input.style.borderColor = '#e0e0e0';
                    // Re-render to show audio player
                    renderShlokas();
                }, 1000);
            }
        }

        // Save note
        function saveNote(textarea) {
            const srNumber = textarea.dataset.sr;
            const note = textarea.value;
            
            // Find and update the shloka
            const shloka = allShlokas.find(s => s['sr#'] === srNumber);
            if (shloka) {
                shloka.notes = note;
                
                // Save all data to localStorage
                localStorage.setItem('gitaData', JSON.stringify({ shlokas: allShlokas }));
                
                // Visual feedback
                textarea.style.borderColor = '#a78bfa';
                setTimeout(() => {
                    textarea.style.borderColor = '#e0e0e0';
                }, 800);
            }
        }

        // Load saved notes from localStorage
        function loadSavedNotes() {
            const savedData = localStorage.getItem('gitaData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    // Merge saved notes into current data
                    data.shlokas.forEach(savedShloka => {
                        const shloka = allShlokas.find(s => s['sr#'] === savedShloka['sr#']);
                        if (shloka && savedShloka.notes) {
                            shloka.notes = savedShloka.notes;
                        }
                    });
                } catch (e) {
                    console.error('Error loading saved notes:', e);
                }
            }
        }

        // Download JSON with notes
        function downloadJSON() {
            const dataStr = JSON.stringify({ shlokas: allShlokas }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'gita-with-notes.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Upload JSON file
        function uploadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.shlokas && Array.isArray(data.shlokas)) {
                        allShlokas = data.shlokas;
                        
                        // Save to localStorage
                        localStorage.setItem('gitaData', JSON.stringify(data));
                        
                        // Re-render the page
                        renderShlokas();
                        
                        // Show success message
                        alert('‚úÖ JSON uploaded successfully! Your notes have been restored.');
                    } else {
                        alert('‚ùå Invalid JSON format. Please upload a valid gita.json file.');
                    }
                } catch (error) {
                    alert('‚ùå Error reading JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input so same file can be uploaded again
            event.target.value = '';
        }

        // Toggle card expand/collapse
        function toggleCard(headerElement) {
            const card = headerElement.closest('.shloka-card');
            card.classList.toggle('expanded');
        }

        // Filter by tag from dropdown or click
        function filterByTag(tag) {
            document.getElementById('tagFilter').value = tag;
            filterShlokas();
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchText').value = '';
            document.getElementById('chapterFilter').value = '';
            document.getElementById('tagFilter').value = '';
            document.getElementById('shlokaNumber').value = '';
            filterShlokas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Filter shlokas
        function filterShlokas() {
            const searchText = document.getElementById('searchText').value.toLowerCase();
            const chapterFilter = document.getElementById('chapterFilter').value;
            const shlokaNumber = document.getElementById('shlokaNumber').value.toLowerCase();
            const tagFilter = document.getElementById('tagFilter').value.toLowerCase();
            
            filteredShlokas = allShlokas.filter(shloka => {
                // Text search
                const matchesText = !searchText || 
                    shloka.summary.toLowerCase().includes(searchText) ||
                    shloka.details.toLowerCase().includes(searchText) ||
                    shloka.tags.some(tag => tag.toLowerCase().includes(searchText));
                
                // Chapter filter
                const matchesChapter = !chapterFilter || shloka.chapter == chapterFilter;
                
                // Shloka number search
                const matchesShloka = !shlokaNumber || shloka.shloka.toLowerCase().includes(shlokaNumber);
                
                // Tag dropdown filter
                const matchesTag = !tagFilter || 
                    shloka.tags.some(tag => tag.toLowerCase() === tagFilter);
                
                return matchesText && matchesChapter && matchesShloka && matchesTag;
            });
            
            renderShlokas();
        }

        // Event listeners
        document.getElementById('searchText').addEventListener('input', filterShlokas);
        document.getElementById('chapterFilter').addEventListener('change', filterShlokas);
        document.getElementById('shlokaNumber').addEventListener('input', filterShlokas);
        document.getElementById('tagFilter').addEventListener('change', filterShlokas);

        // Load saved notes from localStorage
        function loadSavedNotes() {
            const saved = localStorage.getItem('gitaNotes');
            if (saved) {
                const savedShlokas = JSON.parse(saved);
                savedShlokas.forEach(saved => {
                    const shloka = allShlokas.find(s => s['sr#'] === saved['sr#']);
                    if (shloka && saved.notes) {
                        shloka.notes = saved.notes;
                    }
                });
            }
        }

        // Load saved audio URLs from localStorage
        function loadSavedAudio() {
            const saved = localStorage.getItem('gitaAudio');
            if (saved) {
                const savedShlokas = JSON.parse(saved);
                savedShlokas.forEach(saved => {
                    const shloka = allShlokas.find(s => s['sr#'] === saved['sr#']);
                    if (shloka && saved.audio) {
                        shloka.audio = saved.audio;
                    }
                });
            }
        }

        // Initialize
        loadData().then(() => {
            loadSavedNotes();
            loadSavedAudio();
            renderShlokas();
        });
    </script>
</body>
</html>
